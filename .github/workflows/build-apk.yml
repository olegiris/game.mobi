name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          git zip unzip openjdk-11-jdk \
          autoconf libtool pkg-config zlib1g-dev \
          libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev ninja-build

    - name: Install Buildozer
      run: |
        pip3 install --upgrade pip wheel setuptools virtualenv
        pip3 install buildozer cython==0.29.33

    - name: Configure Buildozer
      run: |
        # Убедимся, что buildozer.spec корректный
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        # Исправляем главный файл
        sed -i "s|^source.main = .*$|source.main = main.py|" buildozer.spec
        # Упрощаем требования (убираем pygame для первой сборки)
        sed -i "s|^requirements = .*$|requirements = python3,kivy==2.1.0|" buildozer.spec
        # Устанавливаем минимальный API
        sed -i "s|^android.minapi = .*$|android.minapi = 21|" buildozer.spec

    - name: Build with Buildozer
      run: |
        # Запускаем сборку (yes для ответов на все вопросы)
        yes | buildozer android debug 2>&1 | tee build.log
        echo "Build completed with exit code: $?"

    - name: Upload APK
      if: success()  # ПРОСТАЯ ПРОВЕРКА - только если предыдущие шаги успешны
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: bin/*.apk
        retention-days: 7
